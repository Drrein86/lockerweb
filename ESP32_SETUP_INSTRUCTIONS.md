# הוראות התקנה וחיבור ESP32 למערכת לוקרים חכמים

## 🔧 רכיבים נדרשים

### חומרה
- **ESP32 DevKit** (מומלץ ESP32-WROOM-32)
- **ממסרים 5V** (5 יחידות) - לפתיחת תאים
- **חיישני Reed Switch** (5 יחידות) - לזיהוי פתיחה/סגירה
- **LED כחול** - אינדיקטור סטטוס WiFi
- **נגדים 220Ω** (לLED)
- **לוח פיתוח** או PCB
- **חוטי חיבור**
- **ספק כוח 5V/3A**

### תוכנה
- **Arduino IDE** או **PlatformIO**
- **ספריות Arduino:**
  - WiFi (מובנית)
  - WebServer (מובנית)
  - ArduinoJson

## 📋 תרשים חיבורים

### ESP32 Pinout:
```
GPIO 2  -> LED סטטוס WiFi
GPIO 4  -> ממסר תא A1
GPIO 5  -> ממסר תא A2
GPIO 18 -> ממסר תא A3
GPIO 19 -> ממסר תא B1
GPIO 21 -> ממסר תא B2

GPIO 12 -> חיישן דלת A1
GPIO 13 -> חיישן דלת A2
GPIO 14 -> חיישן דלת A3
GPIO 25 -> חיישן דלת B1
GPIO 26 -> חיישן דלת B2

3.3V -> VCC של חיישנים
GND  -> GND של כל הרכיבים
5V   -> VCC של ממסרים
```

### תרשים ממסר:
```
ESP32 GPIO -> ממסר IN
ממסר VCC  -> 5V
ממסר GND  -> GND
ממסר NO   -> מנעול חשמלי (+)
ממסר COM  -> ספק כוח מנעול (+)
```

### תרשים חיישן Reed:
```
חיישן פין 1 -> GPIO של ESP32
חיישן פין 2 -> GND
מגנט -> מותקן על דלת התא
```

## 🔄 התקנת קוד Arduino

### 1. פתיחת Arduino IDE
- הורד את Arduino IDE מ: https://www.arduino.cc/en/software
- התקן ESP32 board package

### 2. התקנת ספריות
```arduino
Tools -> Manage Libraries
חפש והתקן:
- ArduinoJson (by Benoit Blanchon)
```

### 3. העלאת הקוד
- פתח את הקובץ `esp32-locker-firmware.ino`
- עדכן הגדרות WiFi:
```arduino
const char* ssid = "שם_הרשת_שלך";
const char* password = "סיסמת_הרשת_שלך";
```
- בחר לוח: "ESP32 Dev Module"
- העלה את הקוד ל-ESP32

## 🌐 הגדרת רשת

### 1. מצא את כתובת IP של ESP32
- פתח Serial Monitor (115200 baud)
- אתחל את ה-ESP32
- רשום את כתובת ה-IP שמוצגת

### 2. עדכון בשרת Node.js
עדכן את הקובץ `locker-hardware-server.js`:
```javascript
// החלף את כתובות ה-IP האמיתיות
ESP32Controller.registerESP32('LOC001', '192.168.1.100', 80);
ESP32Controller.registerESP32('LOC002', '192.168.1.101', 80);
```

### 3. בדיקת חיבור
גש לכתובת: `http://192.168.1.100` בדפדפן
אמור להופיע מסך סטטוס של הלוקר

## 🔒 הגדרת מערכת נעילה

### סוגי מנעולים נתמכים:
1. **מנעולים חשמליים 12V** - הפעלה ישירה דרך ממסר
2. **מנעולי מגנט אלקטרוני** - שליטה ON/OFF
3. **servo motors** - זווית פתיחה/סגירה
4. **מנעולי מנוע צעד** - סיבוב מדויק

### חיווט מנעול טיפוסי:
```
ממסר NO  -> מנעול (+) כוח
ממסר COM -> ספק כוח (+12V)
מנעול (-) -> ספק כוח GND
```

## 📡 פרוטוקול תקשורת

### פקודות נתמכות:
```json
POST /locker
{
  "action": "unlock",
  "cellId": "A1"
}

POST /locker  
{
  "action": "lock",
  "cellId": "A1",
  "packageId": "PKG123"
}

POST /locker
{
  "action": "checkCell",
  "cellId": "A1"
}

POST /locker
{
  "action": "ping"
}
```

### תגובות:
```json
{
  "success": true,
  "message": "תא נפתח בהצלחה",
  "lockerId": "LOC001",
  "cellId": "A1",
  "timestamp": 1234567890
}
```

## 🔍 בדיקה ואיתור תקלות

### 1. בדיקת WiFi
- LED כחול אמור להיות דולק קבוע כאשר מחובר
- LED מהבהב = אין חיבור WiFi

### 2. בדיקת ממסרים
- עבור לכתובת ESP32 בדפדפן
- בדוק שטבלת התאים מציגה מצב נכון
- שלח פקודת בדיקה:
```bash
curl -X POST http://192.168.1.100/locker \
  -H "Content-Type: application/json" \
  -d '{"action":"unlock","cellId":"A1"}'
```

### 3. בדיקת חיישנים
- פתח/סגור דלת תא
- בדוק ב-Serial Monitor שהמצב משתנה
- ערך חיישן: 1 = סגור, 0 = פתוח

### 4. לוגים
```
🚀 מתחיל ESP32 Smart Locker...
📌 פינים אותחלו
🔌 מתחבר לWiFi.....
✅ WiFi מחובר!
📍 כתובת IP: 192.168.1.100
✅ שרת HTTP פועל
🔄 מצבי תאים אותחלו
✅ ESP32 Smart Locker מוכן לשימוש!
```

## 🔄 מעקב אחר סגירת תאים

המערכת מבצעת מעקב אוטומטי:

1. **פתיחת תא:** ESP32 מפעיל ממסר למשך 3 שניות
2. **זיהוי פתיחה:** חיישן Reed מזהה שהדלת נפתחה
3. **מעקב רציף:** בדיקה כל 2 שניות אם התא נסגר
4. **זיהוי סגירה:** חיישן מזהה חזרה למצב סגור
5. **עדכון מערכת:** הודעה נשלחת לשרת הראשי

### זרימת מידע:
```
אפליקציה -> שרת Node.js -> ESP32 -> פתיחה
ESP32 -> מעקב חיישן -> זיהוי סגירה
ESP32 -> שרת Node.js -> אפליקציה -> עדכון
```

## 🛠️ התאמות מתקדמות

### שינוי זמן פתיחה:
```arduino
delay(3000); // 3 שניות - ניתן לשנות
```

### שינוי תדירות בדיקת חיישנים:
```arduino
if (millis() - lastCheck < 500) return; // 500ms - ניתן לשנות
```

### הוספת אבטחה:
```arduino
// הוסף API key לבקשות
if (doc["apiKey"] != "YOUR_SECRET_KEY") {
  server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
  return;
}
```

## 📞 תמיכה

### תקלות נפוצות:
1. **ESP32 לא מתחבר לWiFi** - בדוק שם רשת וסיסמה
2. **ממסרים לא עובדים** - בדוק מתח ספק כוח
3. **חיישנים לא מגיבים** - בדוק חיבור ומיקום מגנט
4. **השרת לא מגיב** - בדוק חיבור רשת וכתובת IP

### דיבוג Serial:
```arduino
Serial.begin(115200);
// הודעות דיבוג מופיעות ב-Serial Monitor
```

הכל מוכן! המערכת תפעל עם מעקב מלא אחר פתיחה וסגירת תאים 🚀 